<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🐅&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>HAPI-FHIR Database 轉置資料 (二) ⇒ 實作&nbsp;|&nbsp;ChinLin’s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="HAPI-FHIR Database 轉置資料 (二) ⇒ 實作">
  
    <meta name="description" content="轉資料轉到死">
    <meta property="og:description" content="轉資料轉到死">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;💻&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🐅&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F2529def0-9031-44bd-94d3-e6da4b9e887c%2F%E5%86%A0%E8%B2%93%E6%80%9D%E8%80%83.png?table=block&amp;id=721d7aeb-cf52-4f6f-9a86-648e0e7bfcb1"></span>&nbsp;
          
          <span>關於我</span>
        </div>
      </a>
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;💻&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">HAPI-FHIR Database 轉置資料 (二) ⇒ 實作</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Jan 18, 2022</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/HAPI-FHIR.html">HAPI-FHIR</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/FHIR.html">FHIR</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/SQL.html">SQL</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/TS.html">TS</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/5fd7d863214941819241a15a22303517" class="PageRoot"><div id="https://www.notion.so/b5eaa5ad20a0445b8ca6447dd9c85de0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不太了解HAPI-FHIR的資料庫結構可以看看上一篇[</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="Ohf1ph.html">HAPI-FHIR Database (一) ⇒ Database結構</a></span><span class="SemanticString">]</span></span></p></div><div id="https://www.notion.so/a77cb04dbefc4fb2b5281164fa2ad102" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此篇將用Typescript實作從HAPI FHIR資料庫轉置資料到另一個FHIR Server。</span></span></p></div><h1 id="https://www.notion.so/5b52c70b86164fe1bfcbe542eded88f9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5b52c70b86164fe1bfcbe542eded88f9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">使用的程式</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">語言</strong></strong></span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/450f4c34258c4db5b8c509bea9f3f69f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Typescript</span></span></li></ul><h1 id="https://www.notion.so/dd46bafb5428436abf1df95b22de6c90" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/dd46bafb5428436abf1df95b22de6c90"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">使用到的套件</strong></strong></span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/52eb5352e44a4deb90e54437a92408cd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">axios (用於API操作)</span></span></li><li id="https://www.notion.so/2b356d731fee4ad79b484a5ffddac8f9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">pg</span></span></li><li id="https://www.notion.so/7e661af672d84b02883455ad1d63cc65" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">sequelize</span></span></li></ul><pre id="https://www.notion.so/a5b87cfde2f14e93834e9a211758e3e9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token function">npm</span> i axios pg sequelize</span></span></span></code></pre><h1 id="https://www.notion.so/61a59aecf8e94cb8af148a99b70d5be5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/61a59aecf8e94cb8af148a99b70d5be5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">實作</strong></strong></span></span></h1><h2 id="https://www.notion.so/0e70b7c9ec5d4a76a8bf77a476090e14" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0e70b7c9ec5d4a76a8bf77a476090e14"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">第一步：</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">初始化Typescript專案</strong></strong></span></span></h2><pre id="https://www.notion.so/022bea1409a843e4a81a7a137c827507" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token function">npm</span> init -y <span class="token punctuation">\</span>
tsc --init</span></span></span></code></pre><h3 id="https://www.notion.so/e03cc83abc8940fd9e63e81b53ff6eb6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e03cc83abc8940fd9e63e81b53ff6eb6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ℹ️ 整體資料夾結構與內容</strong></span></span></h3><div id="https://www.notion.so/d4d84d1b6f7b4cce8e118bcfec35679c" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F058b25e7-ffa7-46ac-aa8d-a1913e17b132%2FUntitled.png?width=142&amp;table=block&amp;id=d4d84d1b-6f7b-4cce-8e11-8bcfec35679c"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F058b25e7-ffa7-46ac-aa8d-a1913e17b132%2FUntitled.png?width=142&amp;table=block&amp;id=d4d84d1b-6f7b-4cce-8e11-8bcfec35679c" style="width:142px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/6d727b0ba5b746cfac3dab0e687724f2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">config</code></span><span class="SemanticString">：放設定檔</span></span></li><li id="https://www.notion.so/48e2e32cc9ce428db3f3991856f19896" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">models</code></span><span class="SemanticString">：放資料模型SQL、Interface</span></span></li><li id="https://www.notion.so/583430e5acb349438f61f117348c2bcb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">utils</code></span><span class="SemanticString">：公用，放資料操作CRUD等</span></span></li></ul><h2 id="https://www.notion.so/f2db5b383d924dd5bf083e5a95038f1f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f2db5b383d924dd5bf083e5a95038f1f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">第二步：撰寫設定檔</span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/25a4ba8744bf40c0bf889fbab8d24f26" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">路徑：</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">config/config.ts</code></span></span></li><li id="https://www.notion.so/7b8d9f1e72d64fa18c1f8e3e9129e002" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">設定</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SQL</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">FHIR</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">轉置資料</code></span><span class="SemanticString">等設定</span></span></li></ul><div id="https://www.notion.so/f1c1828b49ac45a0a9d4cb6c13c7800b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/95f965266e314ffba924f923217c92ae" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    db <span class="token operator">:</span> <span class="token punctuation">{</span>
        service <span class="token operator">:</span> <span class="token string">"postgres"</span> <span class="token punctuation">,</span> <span class="token comment">//only support postgres now</span>
        username <span class="token operator">:</span> <span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token comment">//postgresql 帳號</span>
        password <span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token comment">//postgresql 密碼</span>
        database <span class="token operator">:</span> <span class="token string">"hapi"</span> <span class="token punctuation">,</span> <span class="token comment">//要連接的database名稱</span>
        hostName <span class="token operator">:</span> <span class="token string">"localhost"</span> <span class="token punctuation">,</span> <span class="token comment">//postgresql 連接之hostname</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sync<span class="token operator">:</span> <span class="token punctuation">{</span>
        limit<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">//pagination limit</span>
        totalWorker<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">//併行處理數量</span>
        FHIRBaseURL<span class="token operator">:</span> <span class="token string">"http://localhost:8088/fhir/"</span> <span class="token punctuation">,</span> <span class="token comment">//the FHIR base URL</span>
        haveAuthToken <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//if FHIR server need to auth to use, please change to true</span>
        token <span class="token operator">:</span> <span class="token string">"token"</span><span class="token punctuation">,</span> <span class="token comment">// the authorization token</span>
        method<span class="token operator">:</span> <span class="token string">"put"</span> <span class="token comment">//using `create` or `update` to sync data</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/5d9ce6c2c92c4738891a8c574f6fccd2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5d9ce6c2c92c4738891a8c574f6fccd2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">第三步：</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">定義SQL資料表</strong></strong></span></span></h2><div id="https://www.notion.so/b0e61fd0abca4d4c8d8416d4ecd12392" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">資料夾結構與內容</span></span></p></div><div id="https://www.notion.so/60322774c6d849878a8fda0eda9b0801" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5da1ac94-a090-4772-a453-eeeb40fd7468%2FUntitled.png?width=154&amp;table=block&amp;id=60322774-c6d8-4987-8a8f-da0eda9b0801"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5da1ac94-a090-4772-a453-eeeb40fd7468%2FUntitled.png?width=154&amp;table=block&amp;id=60322774-c6d8-4987-8a8f-da0eda9b0801" style="width:154px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/cbec7c2fd42f44dc938d8c0408a1145d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/cbec7c2fd42f44dc938d8c0408a1145d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">models/sql/hfj_res_sync.ts</strong></strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/19e5f83362d949bca65740c93fb9e2e9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">此檔案為</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hfj_res_sync</code></span><span class="SemanticString">資料表的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Sequelize</code></span><span class="SemanticString">程式碼定義。</span></span></li><li id="https://www.notion.so/4a3ac0d451c84ef1a47639bf013a8628" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hfj_res_sync</code></span><span class="SemanticString">用於記錄已轉置資料之來源ID、Resource Type、Resource Version以及目標之ID。</span></span></li></ul><pre id="https://www.notion.so/950ac8c0d23b4c228e38857bd7350f3b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token punctuation">{</span> Sequelize<span class="token punctuation">,</span> DataTypes<span class="token punctuation">,</span> Model <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'sequelize'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 
 * @param {Sequelize} sequelize 
 * @returns {Model}
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sequelize<span class="token operator">:</span> Sequelize<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hfj_res_sync <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'hfj_res_sync'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//記錄在HAPI-FHIR的唯一ID，即Resource ID</span>
        res_id<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">BIGINT</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//Resource Type</span>
        res_type<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//Resource Version</span>
        res_ver<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">BIGINT</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//目標FHIR Server創建Resource回傳的ID</span>
        sync_id <span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        timestamps <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        freezeTableName<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hfj_res_sync<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/2b8a6d0a1acd40d096835d57ec9a48e5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2b8a6d0a1acd40d096835d57ec9a48e5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">models/sql/index.ts</strong></strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/050d68a3fdbd41bdaaa34599258c525d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">匯出Sequelize主體物件的檔案，以操作資料表CRUD功能。</span></span></li><li id="https://www.notion.so/d3214e3b81264ce5ba37c27229cd6a0d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">包含連接資料庫、創建資料表等。</span></span></li></ul><pre id="https://www.notion.so/eea486fc866545f4beea30ed4cba59dd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token punctuation">{</span> Sequelize<span class="token punctuation">,</span> Op<span class="token punctuation">,</span> Dialect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'sequelize'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../config/config'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>db<span class="token punctuation">.</span>database  <span class="token punctuation">,</span> config<span class="token punctuation">.</span>db<span class="token punctuation">.</span>username <span class="token punctuation">,</span> config<span class="token punctuation">.</span>db<span class="token punctuation">.</span>password <span class="token punctuation">,</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> config<span class="token punctuation">.</span>db<span class="token punctuation">.</span>hostName<span class="token punctuation">,</span>
    dialect<span class="token operator">:</span>  config<span class="token punctuation">.</span>db<span class="token punctuation">.</span>service <span class="token keyword">as</span> Dialect<span class="token punctuation">,</span> <span class="token comment">//mssql</span>
    <span class="token comment">// logging : false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'./hfj_res_sync'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sequelize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//exec this function when you init</span>

<span class="token comment">/**
 * @type {Sequelize}
 */</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">[</span><span class="token string">'hfj_res_sync'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connection has been established successfully.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sequelize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Unable to connect to the database:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h3 id="https://www.notion.so/42e8ccaeb78e47e6a76db9fee9650d66" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/42e8ccaeb78e47e6a76db9fee9650d66"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">models/resource.ts</strong></strong></span></span></h3><pre id="https://www.notion.so/b7a9398144e44ae4b0020a104e830b06" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IResource</span> <span class="token punctuation">{</span>
    res_id <span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    res_ver<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/7eab4f978d9a4dcfabbf291fff90bbae" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7eab4f978d9a4dcfabbf291fff90bbae"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">models/resouce_ver.ts</strong></strong></span></span></h3><div id="https://www.notion.so/688fecc50d494fcf941d3066f7b4da91" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">從HAPI-FHIR </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hfj_res_ver</code></span><span class="SemanticString">
取回資料之interface，這邊我們只會用到</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">res_id</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">res_ver</code></span><span class="SemanticString">、</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lo_get</code></span><span class="SemanticString">。</span></span></p></div><pre id="https://www.notion.so/c62e7beeb7194552bc2916336f1c8fef" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IResourceVer</span> <span class="token punctuation">{</span>
    res_id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    res_ver<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    lo_get<span class="token operator">:</span> Buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/4c8759d982b04fca838d5d9656339f16" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/4c8759d982b04fca838d5d9656339f16"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">第四步：</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">資料操作程式</strong></strong></span></span></h2><div id="https://www.notion.so/1fda5da261a44ee4957837b3c63e459b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">資料夾結構與內容</span></span></p></div><div id="https://www.notion.so/1b7dc3c2f3b84328b58463735118df13" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F59f3d021-4c0d-47ff-bd33-debf20b98579%2FUntitled.png?width=129&amp;table=block&amp;id=1b7dc3c2-f3b8-4328-b584-63735118df13"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F59f3d021-4c0d-47ff-bd33-debf20b98579%2FUntitled.png?width=129&amp;table=block&amp;id=1b7dc3c2-f3b8-4328-b584-63735118df13" style="width:129px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/ef3cb95753a343bfaac923493394a6b3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/ef3cb95753a343bfaac923493394a6b3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">utils/lob.ts</strong></strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/5090e686a7dd4825aa86a93c58430858" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">把HAPI-FHIR</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hfj_res_ver</code></span><span class="SemanticString">資料表中的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">res_text</code></span><span class="SemanticString">欄位LOB轉成JSON。</span></span></li><li id="https://www.notion.so/b33e289928f44816a062bc7cb0a79e62" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">由於轉出來的LOB有經過gzip壓縮過，所以有一段Gunzip的程式碼。</span></span></li></ul><pre id="https://www.notion.so/1aef711e78ac4005802fd57bb040c90a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> stream <span class="token keyword">from</span> <span class="token string">'stream'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> zlib <span class="token keyword">from</span> <span class="token string">'zlib'</span><span class="token punctuation">;</span>

<span class="token comment">//Gunzip file : https://stackoverflow.com/questions/12148948/how-do-i-ungzip-decompress-a-nodejs-requests-module-gzip-response-body</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">convertLOBToJson</span> <span class="token operator">=</span> <span class="token punctuation">(</span>iLOB<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> buffer<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> bufferStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">stream</span><span class="token punctuation">.</span><span class="token function">PassThrough</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// Write your buffer</span>
        bufferStream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>iLOB<span class="token punctuation">.</span>lo_get<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// Pipe it to something else  (i.e. stdout)</span>
        <span class="token comment">// 解壓縮LOB回傳之Binary</span>
        <span class="token keyword">let</span> gunzip <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">createGunzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gunzip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gunzip<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// decompression chunk ready, add it to the buffer</span>
            buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// response and decompression complete, join the buffer and return</span>
            <span class="token comment">//callback(null, buffer.join(""));</span>
            <span class="token keyword">let</span> bufferStr <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> jsonItem <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>bufferStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>jsonItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//callback(e);</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/444e33e3c01f47bf89c3295c37815072" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/444e33e3c01f47bf89c3295c37815072"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">utils/res.ts</strong></strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/29fb3168c35f46eda286bfc1f98f5ed6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">取得在hfj_resource的資料</span></span></li><li id="https://www.notion.so/6d7a463e2b0e495db35d5b38b55ad331" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">取得hfj_res_ver單個Resource資料</span></span></li></ul><pre id="https://www.notion.so/57b9791e4605417ba50d892d6ce968a8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token punctuation">{</span> QueryTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IResource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../models/resource"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 用於取得hfj_resource資料的id, resource type, 最新res_ver
 * @param limit SQL query data limit count
 * @param offset SQL query data offset
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> getResources <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>limit<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>IResource<span class="token operator">>></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../models/sql/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT res_type, res_id, res_ver FROM hfj_resource LIMIT </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> OFFSET </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 取得hfj_res_ver單個Resource資料
 * @param resId Resource id
 * @param resVer Resource Version
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>resId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> resVer<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../models/sql/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT lo_get(res_text), res_id, res_ver FROM hfj_res_ver WHERE res_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and res_ver=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resVer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> getResourcesCountByResourceType<span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../models/sql/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT COUNT(*) FROM hfj_resource</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Number</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/202d678192f148f0aec20ba3b174a897" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/202d678192f148f0aec20ba3b174a897"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">utils/res_sync.ts</strong></strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/86aa1040df254565ad94d5c4db9e3078" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">取得hfj_res_sync某Resource id已轉置的資料</span></span></li><li id="https://www.notion.so/0ff2629e3ecd4946a554060bab653296" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">新增hfj_res_sync已轉置資料</span></span></li></ul><pre id="https://www.notion.so/2097a13db139459087bc0579a2d50539" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> QueryTypes<span class="token punctuation">,</span> Sequelize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../config/config"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IResource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../models/resource"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> log <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/log'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 取得hfj_res_sync某Resource id已轉置的資料，如果沒資料回傳空陣列[]
 * @param resId Resource id
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getSyncedResourceById</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>resId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../models/sql/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT res_id, res_ver FROM hfj_res_sync WHERE res_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 新增hfj_res_sync已轉置資料
 * @param resourceType resource type e.g. Patient
 * @param syncId The target FHIR Server response id 
 * @param resource hfj_resource content
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">addSyncResource</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>resourceType<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> syncId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> resource<span class="token operator">:</span> IResource<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> syncResource<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> resource<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        syncResource<span class="token punctuation">[</span><span class="token string">"res_type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> resourceType<span class="token punctuation">;</span>
        syncResource<span class="token punctuation">[</span><span class="token string">"sync_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> syncId<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sequelize<span class="token operator">:</span> Sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../models/sql/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> syncedResource <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">[</span><span class="token string">"hfj_res_sync"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token operator">:</span> <span class="token punctuation">{</span>
                res_id <span class="token operator">:</span> resource<span class="token punctuation">.</span>res_id
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>syncedResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">[</span><span class="token string">"hfj_res_sync"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>syncResource <span class="token punctuation">,</span> <span class="token punctuation">{</span>
                where<span class="token operator">:</span> <span class="token punctuation">{</span>
                    res_id <span class="token operator">:</span> resource<span class="token punctuation">.</span>res_id
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">[</span><span class="token string">"hfj_res_sync"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>syncResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> syncResource
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> e
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> doSync<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Using PUT `update` Web API to create Resource on target FHIR Server
     * @param resourceType resource type e.g. Patient
     * @param resId Resource id
     * @param resJson Resource JSON content
     */</span>
    <span class="token string-property property">"put"</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>resourceType<span class="token operator">:</span><span class="token builtin">string</span><span class="token punctuation">,</span> resId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> resJson<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> requestConfig<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>haveAuthToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> headers<span class="token operator">:</span> axios<span class="token punctuation">.</span>AxiosRequestHeaders <span class="token operator">=</span> <span class="token punctuation">{</span>
                    Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token punctuation">}</span>
                requestConfig<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>FHIRBaseURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resourceType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> resJson<span class="token punctuation">,</span> 
            requestConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/** Using POST `create` Web API to create Resource on target FHIR Server
     * @param resourceType resource type e.g. Patient
     * @param resId Resource id
     * @param resJson Resource JSON content
     */</span>
    <span class="token string-property property">"post"</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>resourceType<span class="token operator">:</span><span class="token builtin">string</span><span class="token punctuation">,</span> resId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> resJson<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> requestConfig<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>haveAuthToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> headers<span class="token operator">:</span> axios<span class="token punctuation">.</span>AxiosRequestHeaders <span class="token operator">=</span> <span class="token punctuation">{</span>
                    Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token punctuation">}</span>
                requestConfig<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span> <span class="token operator">=</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>FHIRBaseURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resourceType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> resJson<span class="token punctuation">,</span> 
            requestConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/383d3b2d79c14cbca5bc8786a73d7ec1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/383d3b2d79c14cbca5bc8786a73d7ec1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">第五步：程式主體</span></span></h2><h3 id="https://www.notion.so/74d49cbfdd4248968cc3747c16b56346" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/74d49cbfdd4248968cc3747c16b56346"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">index.ts</strong></strong></span></span></h3><pre id="https://www.notion.so/61e1ac95387841e5aadd3d99a51dc8eb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token punctuation">{</span> convertLOBToJson <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils/lob'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getResources<span class="token punctuation">,</span> getResourcesCountByResourceType<span class="token punctuation">,</span> getResource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils/res'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getSyncedResourceById<span class="token punctuation">,</span> addSyncResource<span class="token punctuation">,</span> doSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils/res_sync'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config/config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IResource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./models/resource'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IResourceVer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./models/resource_ver'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Check source FHIR Server content is need to sync to target FHIR Server.
 * @param resource 
 * @param resourceVer 
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">isNeedSync</span><span class="token punctuation">(</span>resource<span class="token operator">:</span>IResource<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> syncedResource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSyncedResourceById</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span>res_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>syncedResource<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> syncedResource<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>res_ver <span class="token operator">===</span> resource<span class="token punctuation">.</span>res_ver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 執行被丟入陣列的promise function
 * @param workerList 
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doWorks</span><span class="token punctuation">(</span>workerList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> doWorkList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>workerList<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        doWorkList <span class="token operator">=</span> workerList<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>totalWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        workerList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>totalWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">allSettled</span><span class="token punctuation">(</span>doWorkList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 新增執行同步資料的function到陣列裡
 * @param worker 當前待執行promise function陣列
 * @param resourceItemList 當前hfj_resource資料
 * @param limit SQL query data limit
 * @param offset SQL query data offset
 */</span>
<span class="token keyword">function</span> <span class="token function">addWork</span><span class="token punctuation">(</span>worker<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span> resourceItemList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span> limit<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> offset<span class="token operator">:</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    worker<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> successCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> resourceItemList<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> resourceItem <span class="token operator">=</span> resourceItemList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> resource <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getResource</span><span class="token punctuation">(</span>resourceItem<span class="token punctuation">.</span>res_id<span class="token punctuation">,</span> resourceItem<span class="token punctuation">.</span>res_ver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> syncResourceType <span class="token operator">=</span> resourceItem<span class="token punctuation">.</span>res_type<span class="token punctuation">;</span>
            <span class="token keyword">let</span> needSync <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">isNeedSync</span><span class="token punctuation">(</span>resourceItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> res_id <span class="token operator">=</span> resourceItem<span class="token punctuation">.</span>res_id<span class="token punctuation">;</span>
                <span class="token keyword">let</span> lobJson <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">convertLOBToJson</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> syncResData <span class="token operator">=</span> <span class="token keyword">await</span> doSync<span class="token punctuation">[</span>config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>syncResourceType<span class="token punctuation">,</span> res_id<span class="token punctuation">,</span> lobJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>syncResData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> addResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addSyncResource</span><span class="token punctuation">(</span>syncResourceType<span class="token punctuation">,</span> syncResData<span class="token punctuation">.</span>id<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>addResult<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        successCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                successCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">convert </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">~</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token operator">+</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> successfully </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>successCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resourceItemList<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 程式主體main
 */</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> worker<span class="token operator">:</span><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> limit <span class="token operator">=</span> config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//取得第一批hfj_resource資料</span>
    <span class="token keyword">let</span> resourceItemList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getResources</span><span class="token punctuation">(</span>limit <span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//執行直到pagination hfj_resource資料長度為0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>resourceItemList<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//當待執行promise function陣列長度與設定檔最大併行數量相同時，併行執行所有promise function</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>worker<span class="token punctuation">.</span>length <span class="token operator">==</span> config<span class="token punctuation">.</span>sync<span class="token punctuation">.</span>totalWorker<span class="token punctuation">)</span> <span class="token keyword">await</span> <span class="token function">doWorks</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addWork</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> resourceItemList<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//When offset is 0, limit is 100 that 0~100, after first processing this will be next page, offset is 100, limit is 100 = 100~200</span>
        offset <span class="token operator">+=</span> limit<span class="token punctuation">;</span>
        <span class="token comment">//get next page `hfj_resource` data</span>
        resourceItemList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getResources</span><span class="token punctuation">(</span>limit <span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//do remain works</span>
    <span class="token keyword">await</span> <span class="token function">doWorks</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><h1 id="https://www.notion.so/8a7cb6ce71854384b45120a5c98c1f8e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/8a7cb6ce71854384b45120a5c98c1f8e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">整體完整程式碼</strong></strong></span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/5c145ff4b7544572a9f2565a3e015beb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Github: </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/Chinlinlee/hapi-sync-mediator-ts">hapi-sync-mediator-ts</a></span></span></li></ul><h1 id="https://www.notion.so/3e40d374cefb40f39cc47d396cb56866" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/3e40d374cefb40f39cc47d396cb56866"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">參考資料</strong></strong></span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/1361a9003ade49758ff1361dc16afab9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://stackoverflow.com/questions/12148948/how-do-i-ungzip-decompress-a-nodejs-requests-module-gzip-response-body">How do I ungzip (decompress) a NodeJS request’s module gzip response body?</a></span></span></li><li id="https://www.notion.so/b861cae04563451d8ede0614ca53f63f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="Ohf1ph.html">HAPI-FHIR Database (一) ⇒ Database結構</a></span></span></li></ul></article>
<br />
<script src="https://utteranc.es/client.js"
  repo="Chinlinlee/Chinlinlee.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>
  <footer class="Footer">
  <div>&copy; ChinLin’s Blog 2021-2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>
<script src="./scripts/code-copy.js"></script>
<script type="text/javascript" src="./scripts/table-of-contents-sidebar-lib/table-of-contents-sidebar.min.js"></script>
<script type="text/javascript">
    window.onload = function(e){
        TableOfContents.init({
            basePath: "./scripts/table-of-contents-sidebar-lib/",
            querySelector: "body" // or other css querySelector
        });
    }
</script>